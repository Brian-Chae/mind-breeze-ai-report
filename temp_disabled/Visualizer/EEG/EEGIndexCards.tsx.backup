import React, { useEffect, useState } from 'react';
import { useEEGAnalysis, useConnectionState } from '../../../stores/processedDataStore';
import { useDeviceStore } from '../../../stores/deviceStore';
import { useSensorContactStatus } from '../../../stores/systemStore';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '../../ui/tooltip';
import { indexGuides } from '../../../constants/indexGuides';
import { AlertTriangle } from 'lucide-react';

const EEGIndexCards: React.FC = () => {
  const { connectionState } = useDeviceStore();
  const eegAnalysis = useEEGAnalysis();
  const isConnected = useConnectionState();
  const { isSensorContacted, leadOffStatus } = useSensorContactStatus();
  const [currentTime, setCurrentTime] = useState(Date.now());

  // 1ì´ˆë§ˆë‹¤ ë°ì´í„° ì—…ë°ì´íŠ¸
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentTime(Date.now());
    }, 1000);

    return () => clearInterval(interval);
  }, []);

  // ì¹´ë“œ ë°ì´í„° ì •ì˜ (processedDataStore EEG ë¶„ì„ ê²°ê³¼ ì‚¬ìš©)
  const cardData = [
    {
      label: 'ì´ íŒŒì›Œ',
      value: eegAnalysis?.indices?.totalPower,
      unit: 'Î¼VÂ²',
      color: 'bg-purple-500',
      description: 'ì „ì²´ ë‡ŒíŒŒ í™œë™ ê°•ë„'
    },
    {
      label: 'ì§‘ì¤‘ë ¥',
      value: eegAnalysis?.indices?.focusIndex,
      unit: '',
      color: 'bg-blue-500',
      description: 'ë² íƒ€íŒŒ ê¸°ë°˜ ì§‘ì¤‘ë„ ì§€ìˆ˜'
    },
    {
      label: 'ì´ì™„ë„',
      value: eegAnalysis?.indices?.relaxationIndex,
      unit: '',
      color: 'bg-green-500',
      description: 'ì•ŒíŒŒíŒŒ ê¸°ë°˜ ì´ì™„ ìƒíƒœ'
    },
    {
      label: 'ìŠ¤íŠ¸ë ˆìŠ¤',
      value: eegAnalysis?.indices?.stressIndex,
      unit: '',
      color: 'bg-red-500',
      description: 'ê³ ì£¼íŒŒ í™œë™ ê¸°ë°˜ ìŠ¤íŠ¸ë ˆìŠ¤'
    },
    {
      label: 'ì¢Œìš°ë‡Œ ê· í˜•',
      value: eegAnalysis?.indices?.hemisphericBalance,
      unit: '',
      color: 'bg-cyan-500',
      description: 'ë°˜êµ¬ê°„ í™œë™ ê· í˜• ì§€í‘œ'
    },
    {
      label: 'ì¸ì§€ ë¶€í•˜',
      value: eegAnalysis?.indices?.cognitiveLoad,
      unit: '',
      color: 'bg-yellow-500',
      description: 'ì„¸íƒ€/ì•ŒíŒŒ ë¹„ìœ¨ ê¸°ë°˜ ì¸ì§€ ë¶€í•˜'
    },
    {
      label: 'ì •ì„œ ì•ˆì •ì„±',
      value: eegAnalysis?.indices?.emotionalStability,
      unit: '',
      color: 'bg-pink-500',
      description: 'ê°ë§ˆíŒŒ ê¸°ë°˜ ì •ì„œ ì•ˆì •ë„'
    }
  ];

  // ì—°ê²°ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
  if (!isConnected || !eegAnalysis?.indices) {
    return (
      <div className="w-full h-80 flex items-center justify-center">
        <div className="text-center space-y-4">
          <div className="text-6xl mb-4">ğŸ§ </div>
          <div className="text-lg text-gray-300">
            ê·¸ë˜í”„ì— í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
          </div>
          <div className="text-sm text-gray-400">
            LINK BAND ë””ë°”ì´ìŠ¤ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”
          </div>
          <div className="text-xs text-gray-500 mt-2">
            ì—°ê²° í›„ ë‡ŒíŒŒ ë¶„ì„ ì§€ìˆ˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          </div>
          <div className="text-xs text-gray-600 mt-3 p-2 bg-gray-800 rounded">
            processedDataStore EEG ë¶„ì„ ê²°ê³¼ ê¸°ë°˜ ì§€ìˆ˜ ê³„ì‚° ì¤‘...
          </div>
        </div>
      </div>
    );
  }

  return (
    <TooltipProvider>
      {/* ì„¼ì„œ ì ‘ì´‰ ìƒíƒœ ê²½ê³  */}
      {isConnected && !isSensorContacted && (
        <div className="mb-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg flex items-center gap-2">
          <AlertTriangle className="h-5 w-5 text-red-400" />
          <div className="text-red-300">
            <div className="font-medium">ì „ê·¹ ì ‘ì´‰ ë¶ˆëŸ‰ ê°ì§€</div>
            <div className="text-sm">
              FP1: {leadOffStatus.fp1 ? 'ì ‘ì´‰ ë¶ˆëŸ‰' : 'ì •ìƒ'}, 
              FP2: {leadOffStatus.fp2 ? 'ì ‘ì´‰ ë¶ˆëŸ‰' : 'ì •ìƒ'} - 
              ë‡ŒíŒŒ ì§€ìˆ˜ ì •í™•ë„ê°€ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            </div>
          </div>
        </div>
      )}
      
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
        {cardData.map((card, index) => (
          <Tooltip key={index}>
            <TooltipTrigger asChild>
              <div className="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center hover:border-gray-600 transition-colors cursor-help">
                <div className={`w-3 h-3 ${card.color} rounded-full mx-auto mb-2`}></div>
                <div className="text-xs text-gray-400 mb-1">{card.label}</div>
                <div className="text-lg font-bold text-white">
                  {card.value !== null && card.value !== undefined 
                    ? `${card.value.toFixed(2)}${card.unit}` 
                    : '--'
                  }
                </div>
                <div className="text-xs text-gray-500 mt-1">{card.description}</div>
              </div>
            </TooltipTrigger>
            <TooltipContent 
              side="top" 
              className="max-w-md p-4 bg-gray-800 border border-gray-600 text-white"
            >
              <div 
                className="text-sm leading-relaxed"
                dangerouslySetInnerHTML={{ 
                  __html: indexGuides[card.label] || 'ì´ ì§€ìˆ˜ì— ëŒ€í•œ ì„¤ëª…ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' 
                }}
              />
            </TooltipContent>
          </Tooltip>
        ))}
      </div>
    </TooltipProvider>
  );
};

export default EEGIndexCards; 